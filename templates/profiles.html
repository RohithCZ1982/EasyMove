{% extends "base.html" %}

{% block title %}Profiles - EasyMove{% endblock %}

{% block content %}
<div class="card">
    <h2>Create/Manage Profile</h2>
    <form id="profile-form">
        <div class="form-group">
            <label for="profile-name">Full Name *</label>
            <input type="text" id="profile-name" required>
        </div>
        <div class="form-group">
            <label for="profile-email">Email *</label>
            <input type="email" id="profile-email" required>
        </div>
        <div class="form-group">
            <label for="profile-phone">Phone *</label>
            <input type="tel" id="profile-phone" required>
        </div>
        <div class="form-group">
            <label for="current-address">Current Address *</label>
            <textarea id="current-address" required></textarea>
        </div>
        <div class="form-group">
            <label for="profile-id">Profile ID (optional, auto-generated if empty)</label>
            <input type="text" id="profile-id" placeholder="Leave empty for auto-generation">
        </div>
        <button type="submit" class="btn">Create/Update Profile</button>
        <button type="button" class="btn btn-secondary" onclick="loadProfiles()">Refresh List</button>
    </form>
</div>

<div class="card">
    <h2>Your Profiles</h2>
    <div id="profile-list" class="profile-list">
        <p class="text-center">Loading profiles...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentProfileId = null;

// Load profiles
async function loadProfiles() {
    try {
        const profiles = await apiCall('/api/profiles');
        const list = document.getElementById('profile-list');
        
        if (Object.keys(profiles).length === 0) {
            list.innerHTML = '<p class="text-center">No profiles yet. Create your first profile above!</p>';
            return;
        }
        
        list.innerHTML = '';
        
        for (const [id, profile] of Object.entries(profiles)) {
            const item = document.createElement('div');
            item.className = 'profile-item';
            item.innerHTML = `
                <h3>${profile.name}</h3>
                <p><strong>Email:</strong> ${profile.email}</p>
                <p><strong>Phone:</strong> ${profile.phone}</p>
                <p><strong>Address:</strong> ${profile.current_address}</p>
                <p><strong>Services:</strong> ${Object.keys(profile.services || {}).length}</p>
                <p><strong>Created:</strong> ${new Date(profile.created_at).toLocaleDateString()}</p>
                <div class="profile-actions">
                    <button class="btn btn-small" onclick="loadProfile('${id}')">Load & Edit</button>
                    <button class="btn btn-small btn-danger" onclick="deleteProfile('${id}')">Delete</button>
                    <a href="{{ url_for('services') }}?profile_id=${id}" class="btn btn-small btn-success">Manage Services</a>
                </div>
            `;
            list.appendChild(item);
        }
    } catch (error) {
        showAlert('Error loading profiles: ' + error.message, 'error');
    }
}

// Load profile for editing
async function loadProfile(profileId) {
    try {
        const profile = await apiCall(`/api/profiles/${profileId}`);
        
        currentProfileId = profile.id;
        document.getElementById('profile-id').value = profile.id;
        document.getElementById('profile-name').value = profile.name;
        document.getElementById('profile-email').value = profile.email;
        document.getElementById('profile-phone').value = profile.phone;
        document.getElementById('current-address').value = profile.current_address;
        
        showAlert('Profile loaded successfully', 'success');
        
        // Scroll to form
        document.getElementById('profile-form').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        showAlert('Error loading profile: ' + error.message, 'error');
    }
}

// Delete profile
async function deleteProfile(profileId) {
    if (!confirm('Are you sure you want to delete this profile? This action cannot be undone.')) {
        return;
    }
    
    try {
        await apiCall(`/api/profiles/${profileId}`, 'DELETE');
        showAlert('Profile deleted successfully', 'success');
        loadProfiles();
    } catch (error) {
        showAlert('Error deleting profile: ' + error.message, 'error');
    }
}

// Profile form submission
document.getElementById('profile-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const profileData = {
        id: document.getElementById('profile-id').value || undefined,
        name: document.getElementById('profile-name').value,
        email: document.getElementById('profile-email').value,
        phone: document.getElementById('profile-phone').value,
        current_address: document.getElementById('current-address').value
    };
    
    try {
        const profile = await apiCall('/api/profiles', 'POST', profileData);
        showAlert('Profile created/updated successfully!', 'success');
        currentProfileId = profile.id;
        document.getElementById('profile-id').value = profile.id;
        loadProfiles();
    } catch (error) {
        showAlert('Error: ' + error.message, 'error');
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', loadProfiles);
</script>
{% endblock %}


